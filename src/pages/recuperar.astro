---
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/ui/Button.astro';

export const prerender = false;

let success = false;
let error = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email') as string;

  if (email) {
    const { supabase } = await import('../lib/supabase');
    const siteUrl = import.meta.env.PUBLIC_SITE_URL || Astro.url.origin;
    
    const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${siteUrl}/auth/restablecer`,
    });

    if (resetError) {
      error = 'Hubo un error al enviar el correo. Por favor intenta de nuevo.';
      console.error(resetError);
    } else {
      success = true;
    }
  } else {
    error = 'Por favor ingresa tu correo electrónico.';
  }
}
---

<BaseLayout title="Recuperar Contraseña | FashionStore">
  <div class="min-h-screen flex items-center justify-center bg-cream-50 px-4 py-12">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block text-3xl font-serif font-bold text-navy-900">
          Fashion<span class="text-gold-600">Store</span>
        </a>
      </div>
      
      <div class="bg-white rounded-2xl shadow-lg p-8">
        <h1 class="text-2xl font-serif font-bold text-navy-900 text-center mb-4">
          Recuperar Contraseña
        </h1>
        
        <p class="text-charcoal-600 text-center mb-8">
          Ingresa tu correo electrónico y te enviaremos las instrucciones para restablecer tu contraseña.
        </p>

        {error && (
          <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm">
            {error}
          </div>
        )}

        {success ? (
          <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm text-center">
            <p class="font-bold mb-2">¡Correo enviado!</p>
            <p>Revisa tu bandeja de entrada (y spam) para encontrar el enlace de recuperación.</p>
            <div class="mt-4">
               <a href="/login" class="text-navy-600 hover:text-navy-800 font-medium">Volver a Inicio de Sesión</a>
            </div>
          </div>
        ) : (
          <form method="POST" class="space-y-5">
            <div>
              <label for="email" class="block text-sm font-medium text-charcoal-700 mb-2">
                Correo Electrónico
              </label>
              <input 
                type="email" 
                id="email" 
                name="email"
                required
                class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none transition-all"
                placeholder="tu@email.com"
              />
            </div>
            
            <Button type="submit" variant="primary" size="lg" fullWidth>
              Enviar Instrucciones
            </Button>
            
            <div class="text-center mt-4">
              <a href="/login" class="text-sm text-charcoal-500 hover:text-navy-600 transition-colors">
                ← Volver a Inicio de Sesión
              </a>
            </div>
          </form>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
