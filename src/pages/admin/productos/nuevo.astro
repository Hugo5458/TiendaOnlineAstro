---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import Button from '../../../components/ui/Button.astro';
import { supabase, getCategories } from '../../../lib/supabase';
import { slugify } from '../../../lib/utils';

export const prerender = false; // SSR

const categories = await getCategories();

let error = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  
  const name = formData.get('name') as string;
  const description = formData.get('description') as string;
  const price = Math.round(parseFloat(formData.get('price') as string) * 100); // Convert to cents
  const compareAtPrice = formData.get('compare_at_price') ? Math.round(parseFloat(formData.get('compare_at_price') as string) * 100) : null;
  const stock = parseInt(formData.get('stock') as string) || 0;
  const categoryId = formData.get('category_id') as string || null;
  const sizes = (formData.get('sizes') as string).split(',').map(s => s.trim()).filter(Boolean);
  const isActive = formData.get('is_active') === 'on';
  const isFeatured = formData.get('is_featured') === 'on';
  const isFlashOffer = formData.get('is_flash_offer') === 'on';
  const imageUrls = (formData.get('image_urls') as string).split('\n').map(s => s.trim()).filter(Boolean);
  
  const slug = slugify(name);
  
  const { error: insertError } = await supabase
    .from('products')
    .insert({
      name,
      slug,
      description,
      price,
      compare_at_price: compareAtPrice,
      stock,
      category_id: categoryId || null,
      sizes,
      images: imageUrls,
      is_active: isActive,
      is_featured: isFeatured,
      is_flash_offer: isFlashOffer,
    })
    .select()
    .single();
  
  if (insertError) {
    error = insertError.message;
  } else {
    return Astro.redirect('/admin/productos');
  }
}
---

<AdminLayout title="Nuevo Producto">
  <div class="max-w-3xl">
    <!-- Back Link -->
    <a href="/admin/productos" class="inline-flex items-center text-charcoal-600 hover:text-navy-600 mb-6">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Volver a productos
    </a>
    
    {error && (
      <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
        {error}
      </div>
    )}
    
    <form method="POST" class="space-y-6">
      <!-- Basic Info -->
      <div class="bg-white rounded-xl shadow-sm border border-charcoal-100 p-6">
        <h2 class="text-lg font-semibold text-navy-900 mb-4">Información Básica</h2>
        
        <div class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-charcoal-700 mb-2">
              Nombre del producto *
            </label>
            <input 
              type="text" 
              id="name" 
              name="name"
              required
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
              placeholder="Ej: Camisa Oxford Azul"
            />
          </div>
          
          <div>
            <label for="description" class="block text-sm font-medium text-charcoal-700 mb-2">
              Descripción
            </label>
            <textarea 
              id="description" 
              name="description"
              rows="4"
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none resize-none"
              placeholder="Describe el producto..."
            ></textarea>
          </div>
          
          <div>
            <label for="category_id" class="block text-sm font-medium text-charcoal-700 mb-2">
              Categoría
            </label>
            <select 
              id="category_id" 
              name="category_id"
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 bg-white focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
            >
              <option value="">Sin categoría</option>
              {categories.map(cat => (
                <option value={cat.id}>{cat.name}</option>
              ))}
            </select>
          </div>
        </div>
      </div>
      
      <!-- Pricing -->
      <div class="bg-white rounded-xl shadow-sm border border-charcoal-100 p-6">
        <h2 class="text-lg font-semibold text-navy-900 mb-4">Precios y Stock</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="price" class="block text-sm font-medium text-charcoal-700 mb-2">
              Precio (€) *
            </label>
            <input 
              type="number" 
              id="price" 
              name="price"
              step="0.01"
              min="0"
              required
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
              placeholder="59.00"
            />
          </div>
          
          <div>
            <label for="compare_at_price" class="block text-sm font-medium text-charcoal-700 mb-2">
              Precio anterior (€)
            </label>
            <input 
              type="number" 
              id="compare_at_price" 
              name="compare_at_price"
              step="0.01"
              min="0"
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
              placeholder="79.00"
            />
            <p class="text-xs text-charcoal-500 mt-1">Para mostrar descuento</p>
          </div>
          
          <div>
            <label for="stock" class="block text-sm font-medium text-charcoal-700 mb-2">
              Stock *
            </label>
            <input 
              type="number" 
              id="stock" 
              name="stock"
              min="0"
              required
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
              placeholder="25"
            />
          </div>
        </div>
      </div>
      
      <!-- Variants -->
      <div class="bg-white rounded-xl shadow-sm border border-charcoal-100 p-6">
        <h2 class="text-lg font-semibold text-navy-900 mb-4">Variantes</h2>
        
        <div>
          <label for="sizes" class="block text-sm font-medium text-charcoal-700 mb-2">
            Tallas disponibles
          </label>
          <input 
            type="text" 
            id="sizes" 
            name="sizes"
            class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
            placeholder="XS, S, M, L, XL, XXL"
            value="XS, S, M, L, XL, XXL"
          />
          <p class="text-xs text-charcoal-500 mt-1">Separadas por comas</p>
        </div>
      </div>
      
      <!-- Images -->
      <div class="bg-white rounded-xl shadow-sm border border-charcoal-100 p-6">
        <h2 class="text-lg font-semibold text-navy-900 mb-4">Imágenes</h2>
        
        <div>
          <label for="image_urls" class="block text-sm font-medium text-charcoal-700 mb-2">
            URLs de imágenes
          </label>
          <textarea 
            id="image_urls" 
            name="image_urls"
            rows="4"
            class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none resize-none font-mono text-sm"
            placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
          ></textarea>
          <p class="text-xs text-charcoal-500 mt-1">Una URL por línea. La primera será la imagen principal.</p>
        </div>
        
        <!-- Image Upload (for Supabase Storage) -->
        <div class="mt-4 p-4 border-2 border-dashed border-charcoal-200 rounded-lg text-center">
          <svg class="w-8 h-8 text-charcoal-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-sm text-charcoal-500">
            Arrastra imágenes aquí o <label for="file-upload" class="text-navy-600 cursor-pointer hover:underline">selecciona archivos</label>
          </p>
          <input id="file-upload" type="file" class="hidden" multiple accept="image/*" />
          <p class="text-xs text-charcoal-400 mt-1">PNG, JPG hasta 5MB</p>
        </div>
      </div>
      
      <!-- Status -->
      <div class="bg-white rounded-xl shadow-sm border border-charcoal-100 p-6">
        <h2 class="text-lg font-semibold text-navy-900 mb-4">Estado y Visibilidad</h2>
        
        <div class="space-y-4">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" name="is_active" checked class="w-5 h-5 rounded border-charcoal-300 text-navy-600 focus:ring-navy-500" />
            <div>
              <span class="font-medium text-charcoal-700">Producto activo</span>
              <p class="text-sm text-charcoal-500">Visible en la tienda</p>
            </div>
          </label>
          
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" name="is_featured" class="w-5 h-5 rounded border-charcoal-300 text-navy-600 focus:ring-navy-500" />
            <div>
              <span class="font-medium text-charcoal-700">Producto destacado</span>
              <p class="text-sm text-charcoal-500">Aparece en la sección de destacados</p>
            </div>
          </label>
          
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" name="is_flash_offer" class="w-5 h-5 rounded border-charcoal-300 text-gold-600 focus:ring-gold-500" />
            <div>
              <span class="font-medium text-charcoal-700">Oferta Flash</span>
              <p class="text-sm text-charcoal-500">Aparece en la sección de ofertas flash</p>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="flex items-center justify-end gap-4">
        <Button href="/admin/productos" variant="ghost">
          Cancelar
        </Button>
        <Button type="submit" variant="primary">
          Crear Producto
        </Button>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
  // File upload handling (for Supabase Storage)
  const fileInput = document.getElementById('file-upload') as HTMLInputElement;
  
  fileInput?.addEventListener('change', async () => {
    const files = fileInput.files;
    if (!files || files.length === 0) return;
    
    // TODO: Implement Supabase Storage upload
    // For now, just show a message
    alert('La subida de archivos a Supabase Storage se configurará cuando tengas las credenciales de Supabase.');
  });
</script>
