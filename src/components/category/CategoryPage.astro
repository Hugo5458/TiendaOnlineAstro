---
import PublicLayout from '../../layouts/PublicLayout.astro';
import ProductCard from '../../components/product/ProductCard.astro';
import { getProducts, getCategories } from '../../lib/supabase';
import CategoryControls from './CategoryControls.tsx';

export interface Props {
  slug: string;
}

const { slug } = Astro.props as Props;

const allCategories = await getCategories();

const isMainCategory = slug === 'hombre' || slug === 'mujer';

// Encontrar la categoría actual
const currentCategory = allCategories.find(c => c.slug === slug);

// Encontrar categorías principales (Hombre = id 1, Mujer = id 2)
const hombreCategory = allCategories.find(c => c.slug === 'hombre');
const mujerCategory = allCategories.find(c => c.slug === 'mujer');

// Listas exclusivas de cada categoría para fallback (cuando no hay parent_id)
const hombreExclusiveSlugs = ['camisas-hombre', 'pantalones-hombre', 'calzado-hombre', 'trajes', 'chalecos', 'camisetas', 'camisas', 'pantalones'];
const mujerExclusiveSlugs = ['vestidos', 'blusas', 'faldas', 'calzado-mujer', 'accesorios'];

// Determinar categoría padre usando parent_id real de la base de datos
let parentCategory: { name: string; slug: string } | null = null;
if (!isMainCategory) {
  // Primero intentar con parent_id de la base de datos
  if (currentCategory?.parent_id) {
    const parent = allCategories.find(c => c.id === currentCategory.parent_id);
    if (parent) {
      // Limpiar el nombre (quitar emojis si los tiene)
      const cleanName = parent.name.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
      parentCategory = { 
        name: cleanName || parent.name, 
        slug: parent.slug 
      };
    }
  }
  
  // Fallback: si no encontró parent por parent_id, usar listas hardcodeadas
  if (!parentCategory) {
    if (hombreExclusiveSlugs.includes(slug)) {
      parentCategory = { name: 'Hombre', slug: 'hombre' };
    } else if (mujerExclusiveSlugs.includes(slug)) {
      parentCategory = { name: 'Mujer', slug: 'mujer' };
    }
  }
}

// Listas de fallback para subcategorías
const hombreSubcatSlugs = ['camisas', 'pantalones', 'camisetas', 'chalecos', 'trajes', 'accesorios', 
                           'camisas-hombre', 'pantalones-hombre', 'calzado-hombre'];
const mujerSubcatSlugs = ['vestidos', 'blusas', 'faldas', 'calzado-mujer', 'accesorios', 
                          'camisas', 'pantalones'];

// Determine subcategories - usar parent_id primero, fallback a listas hardcodeadas
let subcategories: typeof allCategories = [];
if (isMainCategory) {
  // Primero intentar con parent_id
  if (slug === 'hombre' && hombreCategory) {
    subcategories = allCategories.filter(c => c.parent_id === hombreCategory.id);
  } else if (slug === 'mujer' && mujerCategory) {
    subcategories = allCategories.filter(c => c.parent_id === mujerCategory.id);
  }
  
  // Si no encontró subcategorías por parent_id, usar fallback
  if (subcategories.length === 0) {
    const fallbackSlugs = slug === 'hombre' ? hombreSubcatSlugs : mujerSubcatSlugs;
    subcategories = allCategories.filter(c => fallbackSlugs.includes(c.slug));
  }
}

// Fetch products
let allProducts = [];
if (isMainCategory) {
  allProducts = await getProducts();
} else {
  allProducts = await getProducts({ categorySlug: slug });
}

// Filter products for main categories
let products = [];
if (isMainCategory) {
  // Obtener todos los slugs de subcategorías (tanto por parent_id como fallback)
  const subcategorySlugs = subcategories.map(s => s.slug);
  
  // También incluir los slugs hardcodeados para mayor cobertura
  const allRelevantSlugs = slug === 'hombre' 
    ? [...new Set([...subcategorySlugs, ...hombreSubcatSlugs])]
    : [...new Set([...subcategorySlugs, ...mujerSubcatSlugs])];
  
  products = allProducts.filter(p => allRelevantSlugs.includes(p.category?.slug || ''));
} else {
  products = allProducts.filter(p => p.category?.slug === slug);
}

// Capitalize category name - usar el nombre real de la categoría si existe
let categoryName = slug.charAt(0).toUpperCase() + slug.slice(1).replace(/-/g, ' ');
if (currentCategory) {
  // Limpiar emojis del nombre
  const cleanName = currentCategory.name.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
  categoryName = cleanName || categoryName;
}

const heroImages: Record<string, string> = {
  'hombre': 'https://images.unsplash.com/photo-1617137968427-85924c800a22?w=1600&h=800&fit=crop',
  'mujer': 'https://images.unsplash.com/photo-1483985988355-763728e1935b?w=1600&h=800&fit=crop',
  'vestidos': 'https://images.unsplash.com/photo-1572804013309-59a88b7e92f1?w=1600&h=800&fit=crop',
  'blusas': 'https://images.unsplash.com/photo-1564257631407-4deb1f99d992?w=1600&h=800&fit=crop',
  'trajes': 'https://images.unsplash.com/photo-1593030761757-71fae45fa0e7?w=1600&h=800&fit=crop',
  'calzado-mujer': 'https://images.unsplash.com/photo-1543163521-1bf539c55dd2?w=1600&h=800&fit=crop',
  'camisas-hombre': 'https://images.unsplash.com/photo-1598033129183-c4f50c736c10?w=1600&h=800&fit=crop',
  'pantalones-hombre': 'https://images.unsplash.com/photo-1624378439575-d8705ad7ae80?w=1600&h=800&fit=crop',
  'calzado-hombre': 'https://images.unsplash.com/photo-1614252235316-8c857d38b5f4?w=1600&h=800&fit=crop',
  'faldas': 'https://images.unsplash.com/photo-1583496661160-fb5886a0abe7?w=1600&h=800&fit=crop',
  'accesorios': 'https://images.unsplash.com/photo-1590874103328-eac38a683ce7?w=1600&h=800&fit=crop',
};
const heroImage = heroImages[slug] || heroImages['hombre'];
---

<PublicLayout title={`${categoryName} | FashionStore`} description={`Compra en la categoría ${categoryName}`}>
  <!-- Breadcrumb Navigation -->
  <nav class="bg-gray-50 border-b border-gray-100">
    <div class="max-w-screen-2xl mx-auto px-4 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <!-- Breadcrumb -->
        <ol class="flex items-center gap-2 text-sm">
          <li>
            <a href="/" class="text-gray-500 hover:text-black transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
              </svg>
              <span class="hidden sm:inline">Inicio</span>
            </a>
          </li>
          {parentCategory && (
            <>
              <li class="text-gray-300">/</li>
              <li>
                <a href={`/categoria/${parentCategory.slug}`} class="text-gray-500 hover:text-black transition-colors">
                  {parentCategory.name}
                </a>
              </li>
            </>
          )}
          <li class="text-gray-300">/</li>
          <li class="font-medium text-black">{categoryName}</li>
        </ol>

        <!-- Back Button -->
        <a 
          href={parentCategory ? `/categoria/${parentCategory.slug}` : '/'}
          class="flex items-center gap-2 text-sm text-gray-600 hover:text-black transition-colors group"
        >
          <svg class="w-5 h-5 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
          </svg>
          <span class="hidden sm:inline">
            {parentCategory ? `Volver a ${parentCategory.name}` : 'Volver al inicio'}
          </span>
          <span class="sm:hidden">Volver</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Hero Banner - P&B Style -->
  <section class="relative aspect-[16/9] md:aspect-[21/9] overflow-hidden">
    <img src={heroImage} alt={categoryName} class="absolute inset-0 w-full h-full object-cover" />
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="text-center">
        {parentCategory && (
          <span class="text-white/70 text-xs uppercase tracking-widest mb-2 block">
            {parentCategory.name}
          </span>
        )}
        <h1 class="text-4xl md:text-6xl lg:text-7xl text-white uppercase tracking-widest font-light">
          {categoryName}
        </h1>
      </div>
    </div>
  </section>

  <!-- Subcategories Navigation - P&B Style -->
  {isMainCategory && subcategories.length > 0 && (
    <section class="border-b border-gray-100">
      <div class="max-w-screen-2xl mx-auto px-4 lg:px-8">
        <nav class="flex items-center gap-6 overflow-x-auto py-4 scrollbar-hide">
          <a 
            href={`/categoria/${slug}`}
            class="text-xs uppercase tracking-widest whitespace-nowrap hover:opacity-70 transition-opacity border-b border-black pb-1"
          >
            Ver todo
          </a>
          {subcategories.map((subcat) => (
            <a 
              href={`/categoria/${subcat.slug}`}
              class="text-xs uppercase tracking-widest text-gray-500 whitespace-nowrap hover:text-black transition-colors"
            >
              {subcat.name}
            </a>
          ))}
        </nav>
      </div>
    </section>
  )}

  <!-- Products Grid -->
  <section class="py-8 lg:py-12">
    <div class="max-w-screen-2xl mx-auto px-4 lg:px-8">
      <!-- Filter Bar - P&B Style -->
      <div class="flex items-center justify-between py-4 border-b border-gray-100 mb-8">
        <span class="text-xs text-gray-500 uppercase tracking-wider">
          {products.length} {products.length === 1 ? 'producto' : 'productos'}
        </span>
        
        <div class="flex items-center gap-4">
          <!-- Filter Button -->
          <button 
            id="filter-toggle"
            class="flex items-center gap-2 text-xs uppercase tracking-wider hover:opacity-70 transition-opacity"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
            Filtrar
          </button>
          
          <!-- Sort Dropdown -->
          <div class="relative">
            <select 
              id="sort-select"
              class="appearance-none bg-transparent text-xs uppercase tracking-wider cursor-pointer hover:opacity-70 transition-opacity pr-6"
            >
              <option value="default">Ordenar por</option>
              <option value="price-asc">Precio: menor a mayor</option>
              <option value="price-desc">Precio: mayor a menor</option>
              <option value="name">Nombre</option>
              <option value="newest">Más recientes</option>
            </select>
            <svg class="w-3 h-3 absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Products Grid - P&B 4 Column -->
      <div id="products-grid">
        <CategoryControls client:load products={products} />
      </div>

      <!-- Empty State -->
      {products.length === 0 && (
        <div class="text-center py-20">
          <p class="text-gray-500 mb-6">No hay productos disponibles en esta categoría</p>
          <a 
            href="/productos" 
            class="inline-block px-8 py-3 bg-black text-white text-xs uppercase tracking-widest hover:bg-gray-800 transition-colors"
          >
            Ver todos los productos
          </a>
        </div>
      )}
    </div>
  </section>
</PublicLayout>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
