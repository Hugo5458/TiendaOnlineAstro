---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { createServerClient } from '../../lib/supabase';

export const prerender = false;

// This page intends to run a one-time setup command based on user request.
// It uses AdminLayout so only the allowed email can access it (security check).

let message = '';
let success = false;

if (Astro.request.method === 'POST') {
  if (!import.meta.env.SUPABASE_SERVICE_ROLE_KEY) {
    message = 'Error: Falta la clave SUPABASE_SERVICE_ROLE_KEY en el archivo .env. Por favor, añádela desde el panel de Supabase (Project Settings -> API).';
  } else {
    const supabaseAdmin = createServerClient();
    
    // Data provided by user
    const profileData = {
      id: '62eacedd-800f-4c34-b48e-d83388acf8f9',
      username: 'eren',
      email: 'hugodelmoral77@gmail.com',
      full_name: 'Hugo del Moral Raposo',
      phone: '603322488',
      address: 'Calle cejfkefkef ',
      postal_code: '11540',
      city: 'Sanlúcar de Barrameda',
      // country: 'España',
      document_number: '49852073X',
      updated_at: new Date().toISOString()
    };

    // Try upsert
    const { error } = await supabaseAdmin.from('profiles').upsert(profileData);
    
    if (error) {
      message = `Error actualizando perfil: ${error.message}`;
    } else {
      success = true;
      message = 'Perfil de administrador actualizado correctamente.';
    }
  }
}
---

<AdminLayout title="Configurar Perfil Admin">
  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm p-8">
    <h1 class="text-2xl font-bold text-navy-900 mb-6">Configurar Perfil Admin</h1>
    
    <p class="text-charcoal-600 mb-6">
      Esta acción actualizará los datos del perfil del usuario <strong>eren</strong> (ID: 62eacedd-800f-4c34-b48e-d83388acf8f9).
    </p>

    {message && (
      <div class={`p-4 rounded-lg mb-6 ${success ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
        {message}
      </div>
    )}

    {/* Form always visible for now to ensure user can see it */}
    <div class="mt-6">
      <form method="POST">
        <button 
          type="submit" 
          style="background-color: #000080; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; display: block;"
        >
          Ejecutar Actualización
        </button>
      </form>
    </div>
    
    {success && (
      <div class="mt-6">
        <a href="/admin" class="text-navy-600 hover:underline">
          &larr; Volver al Dashboard (Éxito)
        </a>
      </div>
    )}
  </div>
</AdminLayout>
