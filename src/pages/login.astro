---
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/ui/Button.astro';

export const prerender = false;

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (accessToken) {
  const { supabase } = await import('../lib/supabase');
  const { data: { user } } = await supabase.auth.getUser(accessToken);
  const ADMIN_EMAILS = ['hugodelmoral77@gmail.com', 'admin@fashionstore.com'];
  const isAdmin = !!user?.email && ADMIN_EMAILS.includes(user.email);
  return Astro.redirect(isAdmin ? '/admin' : '/cuenta');
}

let error = '';
let loginSuccess = false;
let loggedInUsername = '';
let loggedInEmail = '';
let redirectUrl = Astro.url.searchParams.get('redirect') || '/cuenta';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const identifier = formData.get('identifier') as string;
  const password = formData.get('password') as string;
  
  const { supabase, isSupabaseConfigured } = await import('../lib/supabase');
  
  if (!isSupabaseConfigured()) {
    if (identifier && password) {
      loginSuccess = true;
      loggedInUsername = identifier.includes('@') ? identifier.split('@')[0] : identifier;
    } else {
      error = 'Por favor rellena todos los campos';
    }
  } else {
    // Only Email Login
    const email = identifier;

    const { data, error: authError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (authError) {
      error = 'Email o contraseña incorrectos';
    } else if (data.session) {
      // Set Cookies
      Astro.cookies.set('sb-access-token', data.session.access_token, {
        path: '/',
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: 'lax',
        maxAge: 60 * 60 * 24 * 7
      });
      Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
        path: '/',
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: 'lax',
        maxAge: 60 * 60 * 24 * 7
      });
      
      loginSuccess = true;
      loggedInEmail = email;

      if (!Astro.url.searchParams.get('redirect')) {
        const ADMIN_EMAILS = ['hugodelmoral77@gmail.com', 'admin@fashionstore.com'];
        const isAdmin = ADMIN_EMAILS.includes(email);
        redirectUrl = isAdmin ? '/admin' : '/cuenta';
      }
      
      // Get username for display
      if (data.user?.user_metadata?.username) {
        loggedInUsername = data.user.user_metadata.username;
      } else {
        // Fallback: try to fetch from profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', data.user.id)
          .single();
          
        loggedInUsername = profile?.username || email.split('@')[0];
      }
    }
  }
}
---

<BaseLayout title="Iniciar Sesión | FashionStore">
  <div class="min-h-screen flex items-center justify-center bg-cream-50 px-4 py-12">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block text-3xl font-serif font-bold text-navy-900">
          Fashion<span class="text-gold-600">Store</span>
        </a>
        <p class="text-charcoal-600 mt-2">Accede a tu cuenta</p>
      </div>
      
      <!-- Login Form -->
      <div class="bg-white rounded-2xl shadow-lg p-8">
        <h1 class="text-2xl font-serif font-bold text-navy-900 text-center mb-6">
          Iniciar Sesión
        </h1>
        
        {error && (
          <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm">
            {error}
          </div>
        )}
        
        <div class="mb-6">
          <button id="google-login-btn" type="button" class="relative z-10 pointer-events-auto cursor-pointer w-full flex items-center justify-center gap-3 px-4 py-3 border border-charcoal-200 rounded-lg text-charcoal-700 font-medium hover:bg-gray-50 transition-colors bg-white">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
            </svg>
            Continuar con Google
          </button>
        </div>

        <div class="relative flex items-center justify-center mb-6">
          <span class="absolute px-3 bg-white text-sm text-charcoal-400">o accede con tu email</span>
          <div class="w-full border-t border-charcoal-100"></div>
        </div>

        <form method="POST" class="space-y-5">
          <div>
            <label for="identifier" class="block text-sm font-medium text-charcoal-700 mb-2">
              Correo Electrónico
            </label>
            <input 
              type="email" 
              id="identifier" 
              name="identifier"
              required
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none transition-all"
              placeholder="tu@email.com"
            />
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-charcoal-700 mb-2">
              Contraseña
            </label>
            <input 
              type="password" 
              id="password" 
              name="password"
              required
              class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none transition-all"
              placeholder="••••••••"
            />
          </div>
          
          <div class="flex items-center justify-between text-sm">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="w-4 h-4 rounded border-charcoal-300 text-navy-600" />
              <span class="text-charcoal-600">Recordarme</span>
            </label>
            <a href="/recuperar-contrasena" class="text-navy-600 hover:text-navy-800">
              ¿Olvidaste tu contraseña?
            </a>
          </div>
          
          <Button type="submit" variant="primary" size="lg" fullWidth>
            Iniciar Sesión
          </Button>
        </form>
        
        <div class="mt-6 text-center">
          <p class="text-charcoal-600">
            ¿No tienes cuenta?{' '}
            <a href="/registro" class="text-navy-600 hover:text-navy-800 font-medium">
              Regístrate aquí
            </a>
          </p>
        </div>
      </div>
      
      <!-- Back to store -->
      <div class="mt-6 text-center">
        <a href="/" class="text-sm text-charcoal-500 hover:text-navy-600 transition-colors">
          ← Volver a la tienda
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

{loginSuccess && (
  <script is:inline define:vars={{ loggedInUsername, loggedInEmail, redirectUrl }}>
    // Store user info in localStorage
    localStorage.setItem('fashionstore-user', JSON.stringify({
      username: loggedInUsername,
      email: loggedInEmail,
      loggedInAt: new Date().toISOString()
    }));
    // Redirect
    window.location.href = redirectUrl;
  </script>
)}

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: {
      flowType: 'pkce',
    },
  });

  const initGoogleLogin = () => {
    const googleBtn = document.getElementById('google-login-btn') as HTMLButtonElement | null;
    if (!googleBtn) return;

    const resetGoogleBtn = () => {
      // Asegura que el botón sea clickeable incluso si quedó marcado como disabled
      googleBtn.disabled = false;
      googleBtn.removeAttribute('disabled');
      googleBtn.style.pointerEvents = 'auto';
      if (!googleBtn.textContent || googleBtn.textContent === 'Conectando...') {
        googleBtn.textContent = 'Continuar con Google';
      }
    };

    resetGoogleBtn();

    // Si el usuario vuelve desde Google (back button), el navegador puede restaurar el DOM (BFCache)
    // y dejar el botón deshabilitado. pageshow se dispara también en restores.
    window.addEventListener('pageshow', resetGoogleBtn);

    googleBtn.addEventListener('click', async () => {
      let originalText: string | null = null;
      try {
        googleBtn.setAttribute('disabled', 'true');
        originalText = googleBtn.textContent;
        googleBtn.textContent = 'Conectando...';

        const primaryRedirectTo = new URL('/auth/callback', window.location.origin).toString();
        const envSiteUrl = import.meta.env.PUBLIC_SITE_URL;
        const fallbackRedirectTo = envSiteUrl
          ? new URL('/auth/callback', envSiteUrl).toString()
          : null;

        const startOAuth = async (redirectTo: string) => {
          return supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo,
              skipBrowserRedirect: true,
              queryParams: {
                prompt: 'select_account',
              },
            },
          });
        };

        let { data, error } = await startOAuth(primaryRedirectTo);
        if (error && fallbackRedirectTo && fallbackRedirectTo !== primaryRedirectTo) {
          ({ data, error } = await startOAuth(fallbackRedirectTo));
        }

        if (error) throw error;
        if (!data?.url) throw new Error('No se recibió la URL de autenticación.');

        window.location.assign(data.url);
      } catch (e) {
        const message = e instanceof Error ? e.message : String(e);
        alert('Error iniciando sesión con Google: ' + message);

        googleBtn.removeAttribute('disabled');
        googleBtn.textContent = originalText || 'Continuar con Google';
      }
    });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGoogleLogin);
  } else {
    initGoogleLogin();
  }
</script>


