---
import BaseLayout from '../../layouts/BaseLayout.astro';

// Seteamos prerender a false
export const prerender = false;
---

<BaseLayout title="Autenticando... | FashionStore">
  <div class="min-h-screen flex flex-col items-center justify-center bg-cream-50 p-4">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900 mx-auto mb-4"></div>
      <p class="text-navy-900 font-medium text-lg">Autenticando...</p>
      <p id="error-msg" class="text-red-500 text-sm mt-4 hidden px-4 py-2 bg-red-50 rounded-lg border border-red-100"></p>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../../lib/supabase';

  // Timeout de seguridad global: si en 8 segundos no pasa nada, redirigir al login
  const safetyTimeout = setTimeout(() => {
     console.warn('Safety timeout triggered');
     const errElem = document.getElementById('error-msg');
     if (errElem) {
         errElem.textContent = 'La autenticación está tardando demasiado. Redirigiendo...';
         errElem.classList.remove('hidden');
     }
     setTimeout(() => window.location.replace('/login'), 2000);
  }, 8000); // 8 segundos

  async function handleAuth() {
    console.log('--- Auth Callback Started ---');
    
    // 1. Verificar si YA tenemos sesión (Supabase auto-detect)
    const { data: { session: initialSession } } = await supabase.auth.getSession();
    
    if (initialSession) {
        console.log('Sesión detectada al inicio.');
        await setCookiesAndRedirect(initialSession);
        return;
    }

    // 2. Si no, esperar a onAuthStateChange (crucial para PKCE flow auto-detect)
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
        console.log(`Auth Event: ${event}`);
        if (event === 'SIGNED_IN' && session) {
            console.log('Evento SIGNED_IN recibido.');
            subscription.unsubscribe();
            await setCookiesAndRedirect(session);
        }
    });

    // 3. Fallback: Si hay código y no ha pasado nada en 2 segundos, intentar manual
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const errorParam = urlParams.get('error');
    
    if (errorParam) {
        reportError('Error recibido en URL: ' + (urlParams.get('error_description') || errorParam));
        return;
    }

    if (code) {
        setTimeout(async () => {
            // Verificar de nuevo antes de intentar manual
            const { data: { session: checkSession } } = await supabase.auth.getSession();
            if (checkSession) return; // Ya se encargó el listener

            console.log('Intentando intercambio manual de código (fallback)...');
            const { data, error } = await supabase.auth.exchangeCodeForSession(code);
            
            if (error) {
                console.warn('Intercambio manual falló (probablemente ya usado):', error.message);
                // Si falla, verificamos una última vez si tenemos sesión
                const { data: { session: finalCheck } } = await supabase.auth.getSession();
                if (finalCheck) {
                    await setCookiesAndRedirect(finalCheck);
                } else {
                    // Si es un error real y no tenemos sesión, reportar
                    if (!error.message.includes('PKCE')) { // Ignorar errores de PKCE duplicados
                        reportError('Error de autenticación: ' + error.message);
                    }
                }
            } else if (data?.session) {
                await setCookiesAndRedirect(data.session);
            }
        }, 2000);
    } else {
        // No hay código ni sesión
        setTimeout(() => {
             // Redirigir si no hay nada pendiente
             window.location.replace('/login');
        }, 3000);
    }
  }

  function reportError(msg: string) {
      clearTimeout(safetyTimeout);
      const errElem = document.getElementById('error-msg');
      if (errElem) {
          errElem.textContent = msg;
          errElem.classList.remove('hidden');
      }
      setTimeout(() => window.location.replace('/login'), 4000);
  }

  async function setCookiesAndRedirect(session: any) {
      clearTimeout(safetyTimeout); // Cancelar timeout de seguridad
      
      console.log('Guardando sesión y redirigiendo...');
      document.cookie = `sb-access-token=${session.access_token}; path=/; max-age=${60 * 60 * 24 * 7}; SameSite=Lax`;
      document.cookie = `sb-refresh-token=${session.refresh_token}; path=/; max-age=${60 * 60 * 24 * 7}; SameSite=Lax`;

      // Store user info in localStorage for client-side usage (e.g. headers, admin panel check)
      if (session.user) {
         localStorage.setItem('fashionstore-user', JSON.stringify({
            username: session.user.user_metadata?.username || session.user.email?.split('@')[0],
            email: session.user.email,
            loggedInAt: new Date().toISOString()
         }));
      }

      const ADMIN_EMAILS = ['hugodelmoral77@gmail.com', 'admin@fashionstore.com'];
      const isAdmin = !!session?.user?.email && ADMIN_EMAILS.includes(session.user.email);
      
      // Intento de obtener perfil, si falla no bloqueamos el login
      try {
        const { data: profile } = await supabase
            .from('profiles')
            .select('phone, address')
            .eq('id', session.user.id)
            .single();

        if (!profile || !profile.phone || !profile.address) {
            window.location.replace('/completar-perfil');
        } else {
            window.location.replace(isAdmin ? '/admin' : '/cuenta');
        }
      } catch (e) {
          console.warn('Error fetching profile, redirecting to account anyway', e);
          window.location.replace(isAdmin ? '/admin' : '/cuenta');
      }
  }

  handleAuth();
</script>
