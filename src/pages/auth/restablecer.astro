---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Button from '../../components/ui/Button.astro';

export const prerender = false;
---

<BaseLayout title="Restablecer Contraseña | FashionStore">
  <div class="min-h-screen flex items-center justify-center bg-cream-50 px-4 py-12">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block text-3xl font-serif font-bold text-navy-900">
          Fashion<span class="text-gold-600">Store</span>
        </a>
      </div>
      
      <div class="bg-white rounded-2xl shadow-lg p-8">
        <h1 class="text-2xl font-serif font-bold text-navy-900 text-center mb-4">
          Nueva Contraseña
        </h1>
        
        <div id="loading-state" class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-navy-900 mx-auto mb-4"></div>
          <p class="text-charcoal-600">Verificando enlace...</p>
        </div>

        <div id="error-state" class="hidden">
           <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm text-center">
            <p id="error-msg" class="font-bold mb-2">Enlace inválido</p>
            <p>El enlace de recuperación ha expirado o es inválido.</p>
            <div class="mt-4">
               <a href="/recuperar" class="text-navy-600 hover:text-navy-800 font-medium">Solicitar nuevo enlace</a>
            </div>
          </div>
        </div>

        <div id="success-state" class="hidden">
           <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm text-center">
            <p class="font-bold mb-2">¡Contraseña Actualizada!</p>
            <p>Tu contraseña ha sido cambiada correctamente.</p>
            <div class="mt-4">
               <a href="/login" class="text-navy-600 hover:text-navy-800 font-medium">Iniciar Sesión</a>
            </div>
          </div>
        </div>

        <form id="reset-form" class="space-y-5 hidden">
            <p class="text-charcoal-600 text-center mb-6 text-sm">
                Ingresa tu nueva contraseña a continuación.
            </p>

            <div>
              <label for="password" class="block text-sm font-medium text-charcoal-700 mb-2">
                Nueva Contraseña
              </label>
              <input 
                type="password" 
                id="password" 
                name="password"
                required
                minlength="6"
                class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none transition-all"
                placeholder="••••••••"
              />
            </div>

            <div>
              <label for="confirm-password" class="block text-sm font-medium text-charcoal-700 mb-2">
                Confirmar Contraseña
              </label>
              <input 
                type="password" 
                id="confirm-password" 
                name="confirm-password"
                required
                minlength="6"
                class="w-full px-4 py-3 rounded-lg border border-charcoal-200 focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none transition-all"
                placeholder="••••••••"
              />
            </div>
            
            <p id="form-error" class="text-red-500 text-sm hidden"></p>

            <Button type="submit" variant="primary" size="lg" fullWidth>
              Cambiar Contraseña
            </Button>
        </form>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseKey, {
    auth: { flowType: 'pkce' }
  });

  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const resetForm = document.getElementById('reset-form');
  const successState = document.getElementById('success-state');
  const formError = document.getElementById('form-error');

  // Inicialización
  async function init() {
    try {
        // 1. Check for errors in URL (e.g. invalid link)
        const urlParams = new URLSearchParams(window.location.search);
        const errorDescription = urlParams.get('error_description');
        if (errorDescription) {
            throw new Error(errorDescription);
        }

        const code = urlParams.get('code');
        
        // Check for hash parameters (Implicit Flow) - used by magic links sometimes
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        const type = hashParams.get('type');

        // 2a. If Hash exists (Implicit Flow), set session manually
        if (accessToken && (type === 'recovery' || type === 'magiclink')) {
             const { data, error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken || ''
             });
             if (error) console.error("Error setting session from hash:", error);
        }

        // 2b. If PKCE code exists, exchange it
        if (code) {
           try {
             const { error } = await supabase.auth.exchangeCodeForSession(code);
             if (error) {
                 // Ignore error if it's just 'Auth session missing' (we'll check session next)
                 console.warn("Auth exchange warning:", error.message);
             }
           } catch (e) {
             console.error("Auth exchange error:", e);
           }
        }

        // 3. Listen for auth state changes (handles Hash fragment flow automatically)
        const checkSessionPromise = new Promise((resolve, reject) => {
            const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'PASSWORD_RECOVERY' || (event === 'SIGNED_IN' && session)) {
                    resolve(session);
                }
            });

            // Also check current session immediately
            supabase.auth.getSession().then(({ data: { session }, error }) => {
                if (error) reject(error);
                if (session) resolve(session);
            });

            // Timeout after 4 seconds if no session found
            setTimeout(() => {
                reject(new Error('No se pudo verificar la sesión. El enlace puede haber expirado.'));
            }, 8000);
        });

        await checkSessionPromise;

        // 4. Success: Show form
        loadingState.classList.add('hidden');
        resetForm.classList.remove('hidden');

    } catch (error) {
        console.error('Error init:', error);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        
        // Mostrar mensaje específico si existe
        const msg = document.getElementById('error-msg');
        if (msg && error.message) {
            // translate common errors
            if (error.message.includes("expired")) {
                 msg.nextElementSibling.textContent = "El enlace ha expirado. Por favor solicita uno nuevo.";
            }
        }
    }
  }

  // Manejar submit
  resetForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirm-password') as string;

    if (password !== confirmPassword) {
        formError.textContent = 'Las contraseñas no coinciden';
        formError.classList.remove('hidden');
        return;
    }

    if (password.length < 6) {
        formError.textContent = 'La contraseña debe tener al menos 6 caracteres';
        formError.classList.remove('hidden');
        return;
    }

    formError.classList.add('hidden');
    const submitBtn = resetForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Actualizando...';
    submitBtn.disabled = true;

    try {
        const { error } = await supabase.auth.updateUser({ password: password });
        
        if (error) throw error;

        resetForm.classList.add('hidden');
        successState.classList.remove('hidden');
        
        // Limpiar sesión para obligar a login nuevo con nueva pass? 
        // Normalmente no hace falta, pero es buena práctica de seguridad o UX
        // await supabase.auth.signOut(); 

    } catch (err) {
        formError.textContent = err.message || 'Error al actualizar contraseña';
        formError.classList.remove('hidden');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
  });

  init();
</script>
