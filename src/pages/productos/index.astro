---
import PublicLayout from '../../layouts/PublicLayout.astro';
import ProductCard from '../../components/product/ProductCard.astro';
import { getProducts, getCategories } from '../../lib/supabase';

export const prerender = false;

// Get all products and categories
const products = await getProducts();
const categories = await getCategories();

// Get filters from URL params
const url = Astro.url;
const categoryFilter = url.searchParams.get('categoria');
const sortBy = url.searchParams.get('orden') || 'newest';
const isOffers = url.searchParams.get('ofertas') === 'true';
const searchQuery = url.searchParams.get('q')?.trim() || '';

let filteredProducts = products;

// Apply search query filter
if (searchQuery) {
  filteredProducts = filteredProducts.filter(p =>
    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    p.description?.toLowerCase().includes(searchQuery.toLowerCase())
  );
}

// Apply offers filter
if (isOffers) {
  filteredProducts = products.filter(p => p.compare_at_price && p.compare_at_price > p.price);
}

// Apply category filter if present
if (categoryFilter) {
  filteredProducts = filteredProducts.filter(p => p.category?.slug === categoryFilter);
}

// Apply sorting
switch (sortBy) {
  case 'price-asc':
    filteredProducts.sort((a, b) => a.price - b.price);
    break;
  case 'price-desc':
    filteredProducts.sort((a, b) => b.price - a.price);
    break;
  case 'name':
    filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
    break;
  // newest is default (already sorted by created_at desc)
}

const pageTitle = searchQuery
  ? `Resultados para "${searchQuery}"`
  : isOffers
    ? 'Rebajas'
    : categoryFilter
      ? categories.find(c => c.slug === categoryFilter)?.name || 'Productos'
      : 'Productos';
---

<PublicLayout title={`${pageTitle} | FashionStore`}>
  <!-- Hero Banner - P&B Style -->
  <section class="bg-gray-100 py-16 lg:py-24 text-center">
    <h1 class="text-4xl md:text-5xl lg:text-6xl uppercase tracking-widest font-light">
      {pageTitle}
    </h1>
    <p class="text-sm text-gray-500 mt-4 uppercase tracking-wider">
      {filteredProducts.length} artículos
    </p>
  </section>

  <div class="max-w-screen-2xl mx-auto px-4 lg:px-8 py-8 lg:py-12">
    <!-- Category Filter Bar -->
    <div class="flex flex-wrap items-center gap-2 mb-6 pb-6 border-b border-gray-100">
      <a
        href="/productos"
        class={`px-4 py-2 text-xs uppercase tracking-widest border transition-all duration-200 ${!categoryFilter && !isOffers ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:border-black'}`}
      >
        Todos
      </a>
      {categories.map(cat => (
        <a
          href={`/productos?categoria=${cat.slug}`}
          class={`px-4 py-2 text-xs uppercase tracking-widest border transition-all duration-200 ${categoryFilter === cat.slug ? 'bg-black text-white border-black' : 'bg-white text-gray-600 border-gray-200 hover:border-black'}`}
        >
          {cat.name}
        </a>
      ))}
      <a
        href="/productos?ofertas=true"
        class={`px-4 py-2 text-xs uppercase tracking-widest border transition-all duration-200 ${isOffers ? 'bg-accent-500 text-white border-accent-500' : 'bg-white text-accent-500 border-gray-200 hover:border-accent-500'}`}
      >
        Rebajas
      </a>
    </div>

    <!-- Filter Bar - P&B Style -->
    <div class="flex items-center justify-between py-4 border-b border-gray-100 mb-8">
      <!-- Breadcrumb -->
      <nav class="text-xs uppercase tracking-wider text-gray-500">
        <a href="/" class="hover:text-black transition-colors">Inicio</a>
        <span class="mx-2">/</span>
        <span class="text-black">{isOffers ? 'Rebajas' : 'Productos'}</span>
      </nav>
      
      <!-- Sort Dropdown -->
      <div class="relative">
        <select 
          id="sort-select"
          class="appearance-none bg-transparent text-xs uppercase tracking-wider cursor-pointer hover:opacity-70 transition-opacity pr-6 focus:outline-none"
        >
          <option value="newest" selected={sortBy === 'newest'}>Más recientes</option>
          <option value="price-asc" selected={sortBy === 'price-asc'}>Precio: menor a mayor</option>
          <option value="price-desc" selected={sortBy === 'price-desc'}>Precio: mayor a menor</option>
          <option value="name" selected={sortBy === 'name'}>Nombre A-Z</option>
        </select>
        <svg class="w-3 h-3 absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
    
    <!-- Products Grid - P&B 4 Columns -->
    {filteredProducts.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
        {filteredProducts.map((product) => (
          <ProductCard product={product} />
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-gray-500 mb-6">No hay productos disponibles</p>
        <a 
          href="/productos" 
          class="inline-block px-8 py-3 bg-black text-white text-xs uppercase tracking-widest hover:bg-gray-800 transition-colors"
        >
          Ver todos los productos
        </a>
      </div>
    )}
  </div>
</PublicLayout>

<script>
  // Sort select handler
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  sortSelect?.addEventListener('change', () => {
    const url = new URL(window.location.href);
    url.searchParams.set('orden', sortSelect.value);
    window.location.href = url.toString();
  });
</script>
